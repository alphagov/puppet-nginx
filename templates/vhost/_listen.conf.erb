<%# Configuration fragment for listening on IPv4 and IPv6 with SSL %>
<% unless sslonly -%>
  listen   <%= port %><%= " default" if isdefaultvhost %>;
<%   if has_variable?( 'ipaddress6' ) -%>
  # Listen on an ipv6 version of this port too, but only do v6 on it, so we
  # don't get strange v4 mapped IPs in v6.
  listen   [::]:<%= port %><%= " default" if isdefaultvhost %> ipv6only=on;
<%   end -%>
<% end -%>

<% if ssl -%>
  # Do SSL, and don't do it terribly.
  listen   <%= ssl_port %><%= " default" if isdefaultvhost %> ssl;
<%   if has_variable?( 'ipaddress6' ) -%>
  # Listen on an ipv6 version of this port too, but only do v6 on it, so we
  # don't get strange v4 mapped IPs in v6.
  listen   [::]:<%= ssl_port %><%= " default" if isdefaultvhost %> ipv6only=on ssl;
<%   end -%>
  ssl_certificate      <%= ssl_path %>/certs/pl_chain.cert;
  ssl_certificate_key  <%= ssl_path %>/private/pl.key;
  ssl_ciphers          ALL:!aNULL:!ADH:!eNULL:!MEDIUM:!LOW:!EXP:RC4:RSA:HIGH:!kEDH;  # use decent and non-crap ciphers.
  ssl_session_timeout  10m;
  ssl_protocols        TLSv1 SSLv3;
  ssl_session_cache    shared:SSL_<%= appname %>:1m;

  # Redirect non-SSL on SSL port to SSL..
  # http://www.ruby-forum.com/topic/193781#844520
  error_page  497  https://$host$request_uri;
<% end -%>
